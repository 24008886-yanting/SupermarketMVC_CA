<div class="container my-5">
    <h2 class="mb-4">My Purchases</h2>

    <% if (orders && orders.length > 0) { %>
        <% orders.forEach(order => {
            const items = order.items || [];
            const derivedSubtotal = items.reduce((sum, item) => {
                const price = parseFloat(item.price) || 0;
                const qty = parseInt(item.quantity) || 0;
                return sum + price * qty;
            }, 0);
            const summary = order.summary || {};
            const subtotal = typeof summary.subtotal === 'number' ? summary.subtotal : derivedSubtotal;
            const shippingFee = typeof summary.shippingFee === 'number'
                ? summary.shippingFee
                : ((subtotal > 0 && subtotal < 60) ? 5.9 : 0);
            const finalTotal = typeof summary.total === 'number' ? summary.total : subtotal + shippingFee;
        %>
            <details class="order-box p-3 mb-3 border rounded bg-light">
                <summary class="order-summary d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-semibold">Order ID: <%= order.order_id %></div>
                        <div class="text-muted small">Date: <%= new Date(order.created_at).toLocaleString() %></div>
                    </div>
                    <div class="text-end">
                        <div class="fw-semibold">Status: <%= order.status %></div>
                        <div class="fw-semibold">Order Total: $<%= finalTotal.toFixed(2) %></div>
                    </div>
                </summary>

                <div class="order-details pt-3">
                    <table class="table table-bordered mb-3">
                        <thead class="table-secondary">
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% items.forEach(item => {
                                const price = parseFloat(item.price) || 0;
                                const qty = parseInt(item.quantity) || 0;
                                const lineTotal = price * qty;
                            %>
                                <tr>
                                    <td><%= item.product_name %></td>
                                    <td><%= qty %></td>
                                    <td>$<%= price.toFixed(2) %></td>
                                    <td>$<%= lineTotal.toFixed(2) %></td>
                                </tr>
                            <% }) %>
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-end">Order Subtotal</th>
                                <th>$<%= subtotal.toFixed(2) %></th>
                            </tr>
                            <tr>
                                <th colspan="3" class="text-end">Shipping</th>
                                <th>
                                    <% if (shippingFee === 0) { %>
                                        <span class="text-success">Free</span>
                                    <% } else { %>
                                        $<%= shippingFee.toFixed(2) %>
                                    <% } %>
                                </th>
                            </tr>
                            <tr>
                                <th colspan="3" class="text-end">Order Total</th>
                                <th>$<%= finalTotal.toFixed(2) %></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </details>
        <% }) %>
    <% } else { %>
        <p>You have no past purchases.</p>
    <% } %>
</div>

<style>
    .order-box {
        padding: 20px;
        border-radius: 10px;
        background-color: #f8f9fa;
    }

    .order-summary {
        cursor: pointer;
        list-style: none;
        user-select: none;
    }

    .order-summary::-webkit-details-marker {
        display: none;
    }

    .order-summary::after {
        content: 'â–¾';
        margin-left: 10px;
        font-size: 1.1rem;
        transition: transform 0.2s ease;
    }

    details[open] .order-summary::after {
        transform: rotate(-180deg);
    }

    .order-details {
        border-top: 1px solid #dee2e6;
    }
</style>
