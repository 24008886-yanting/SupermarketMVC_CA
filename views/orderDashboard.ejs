<div class="container my-5">
    <div class="d-flex flex-column align-items-start gap-3 mb-4">
        <h2 class="mb-0">Order Dashboard</h2>
        <div class="monthly-stats">
            <div class="stats-heading">
                <span>Month snapshot</span>
                <span class="text-muted small"><%= monthlyLabel || '' %></span>
            </div>
            <div class="stats-body d-flex flex-wrap align-items-start gap-4">
                <div class="d-flex flex-wrap align-items-start gap-4">
                    <div class="stat-line d-flex flex-column">
                        <div class="stat-label">Total Revenue</div>
                        <div class="stat-value">$<%= (monthlyStats && typeof monthlyStats.totalRevenue === 'number' ? monthlyStats.totalRevenue : 0).toFixed(2) %></div>
                    </div>
                    <div class="stat-line d-flex flex-column">
                        <div class="stat-label">Total Orders</div>
                        <div class="stat-value"><%= (monthlyStats && typeof monthlyStats.totalOrders === 'number' ? monthlyStats.totalOrders : 0) %></div>
                    </div>
                </div>
                <div class="best-sellers">
                    <div class="stat-label mb-1">Best selling products</div>
                    <% if (monthlyBestSellers && monthlyBestSellers.length) { %>
                        <ul class="best-list mb-0">
                            <% monthlyBestSellers.forEach((item) => { %>
                                <li>
                                    <span class="best-name"><%= item.product_name || 'Product' %></span>
                                    <span class="best-qty"><%= item.total_quantity || 0 %> sold</span>
                                </li>
                            <% }) %>
                        </ul>
                    <% } else { %>
                        <div class="text-muted small">No sales yet.</div>
                    <% } %>
                </div>
            </div>
            <form class="filter-inline d-flex flex-wrap align-items-end gap-2" method="get" action="/order-dashboard">
                <div class="date-field">
                    <label class="form-label text-muted text-uppercase small fw-semibold" for="startDate">Start date</label>
                    <input type="date" id="startDate" name="startDate" class="form-control form-control-sm" value="<%= startDate || '' %>">
                </div>
                <div class="date-field">
                    <label class="form-label text-muted text-uppercase small fw-semibold" for="endDate">End date</label>
                    <input type="date" id="endDate" name="endDate" class="form-control form-control-sm" value="<%= endDate || '' %>">
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Filter</button>
                <a class="btn btn-outline-secondary btn-sm" href="/order-dashboard">Clear</a>
            </form>
        </div>
    </div>

    <% if (startDate || endDate) { %>
        <div class="alert alert-info py-2">
            Showing orders
            <% if (startDate) { %> from <%= startDate %> <% } %>
            <% if (endDate) { %> to <%= endDate %> <% } %>
        </div>
    <% } %>

    <% if (orders && orders.length > 0) { %>
        <% orders.forEach(order => {
            const items = order.items || [];
            const derivedSubtotal = items.reduce((sum, item) => {
                const price = parseFloat(item.price) || 0;
                const qty = parseInt(item.quantity) || 0;
                return sum + price * qty;
            }, 0);
            const summary = order.summary || {};
            const storedTotal = !isNaN(parseFloat(order.total_amount)) ? parseFloat(order.total_amount) : derivedSubtotal;
            const subtotal = typeof summary.subtotal === 'number' ? summary.subtotal : derivedSubtotal;
            const shippingFee = typeof summary.shippingFee === 'number' ? summary.shippingFee : Math.max(0, storedTotal - subtotal);
            const grandTotal = typeof summary.total === 'number' ? summary.total : subtotal + shippingFee;
        %>
            <details class="order-box p-3 mb-4 border rounded bg-light">
                <summary class="order-summary d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-semibold">Order ID: <%= order.order_id %></div>
                        <div class="text-muted small">Date: <%= new Date(order.created_at).toLocaleString() %></div>
                        <div class="text-muted small">User: <%= order.email %></div>
                    </div>
                    <div class="text-end">
                        <div class="fw-semibold">Status: <%= order.status %></div>
                        <div class="fw-semibold">Order Total: $<%= grandTotal.toFixed(2) %></div>
                    </div>
                </summary>

                <div class="order-details pt-3">
                    <div class="mb-3 d-flex justify-content-between align-items-start">
                        <div>
                            <strong>Customer:</strong> <%= order.username %><br>
                            <strong>Address:</strong> <%= order.address || 'N/A' %>
                        </div>
                        <div class="text-end">
                            <strong>Shipping:</strong>
                            <% if (shippingFee === 0) { %>
                                <span class="text-success">Free</span>
                            <% } else { %>
                                $<%= shippingFee.toFixed(2) %>
                            <% } %><br>
                            <strong>Subtotal:</strong> $<%= subtotal.toFixed(2) %>
                        </div>
                    </div>

                    <table class="table table-bordered">
                        <thead class="table-secondary">
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (items && items.length) { %>
                                <% items.forEach(item => {
                                    const price = parseFloat(item.price) || 0;
                                    const qty = parseInt(item.quantity) || 0;
                                    const lineTotal = price * qty;
                                %>
                                    <tr>
                                        <td><%= item.product_name %></td>
                                        <td><%= qty %></td>
                                        <td>$<%= price.toFixed(2) %></td>
                                        <td>$<%= lineTotal.toFixed(2) %></td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No items found for this order.</td>
                                </tr>
                            <% } %>
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-end">Order Subtotal</th>
                                <th>$<%= subtotal.toFixed(2) %></th>
                            </tr>
                            <tr>
                                <th colspan="3" class="text-end">Shipping</th>
                                <th>
                                    <% if (shippingFee === 0) { %>
                                        <span class="text-success">Free</span>
                                    <% } else { %>
                                        $<%= shippingFee.toFixed(2) %>
                                    <% } %>
                                </th>
                            </tr>
                            <tr>
                                <th colspan="3" class="text-end">Order Total</th>
                                <th>$<%= grandTotal.toFixed(2) %></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </details>
        <% }) %>
    <% } else { %>
        <p>No orders have been placed yet.</p>
    <% } %>
</div>

<style>
    .order-box {
        padding: 20px;
        border-radius: 10px;
    }

    .order-summary {
        cursor: pointer;
        list-style: none;
        user-select: none;
    }

    .order-summary::-webkit-details-marker {
        display: none;
    }

    .order-summary::after {
        content: '>';
        margin-left: 10px;
        font-size: 1.1rem;
        transition: transform 0.2s ease;
    }

    details[open] .order-summary::after {
        transform: rotate(90deg);
    }

    .order-details {
        border-top: 1px solid #dee2e6;
        margin-top: 10px;
    }

    .monthly-stats {
        background: #e8f5e9;
        border: 1px solid #99d3a6;
        border-radius: 12px;
        padding: 12px 14px;
        min-width: 280px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.04);
    }

    .stats-heading {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #2e7d32;
        font-weight: 600;
    }

    .stat-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1b5e20;
    }

    .best-sellers {
        min-width: 220px;
    }

    .best-list {
        list-style: none;
        padding-left: 0;
        margin-bottom: 0;
    }

    .best-list li {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
        padding: 4px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .best-list li:last-child {
        border-bottom: none;
    }

    .best-name {
        font-weight: 600;
        color: #1b5e20;
    }

    .best-qty {
        font-size: 0.9rem;
        color: #2e7d32;
        font-weight: 600;
    }

    .filter-inline {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
    }

    .filter-form .form-label {
        margin-bottom: 4px;
    }

    .filter-form .form-control-sm {
        min-width: 160px;
    }

    .date-field {
        display: flex;
        flex-direction: column;
    }
</style>
