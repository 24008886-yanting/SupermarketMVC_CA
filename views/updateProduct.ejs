<!-- Main content -->
<div class="container mt-4">
  <h2 class="text-center mb-4">Update Product</h2>

  <% if (product) { %>
    <% 
      let additionalImages = [];
      if (Array.isArray(product.additionalImages)) {
        additionalImages = product.additionalImages.filter(Boolean);
      } else if (product.additionalImages) {
        try {
          const parsedImages = JSON.parse(product.additionalImages);
          additionalImages = Array.isArray(parsedImages) ? parsedImages.filter(Boolean) : [];
        } catch (e) {
          additionalImages = product.additionalImages.split(',').map(img => img.trim()).filter(Boolean);
        }
      }
    %>
    <form action="/updateProduct/<%= product.id %>" method="POST" enctype="multipart/form-data" class="mx-auto"
      style="max-width: 650px;">

      <div class="mb-3">
        <label for="name" class="form-label">Product Name</label>
        <input type="text" class="form-control" id="name" name="name" value="<%= product.productName %>" required>
      </div>

      <div class="mb-3">
        <label for="category" class="form-label">Category</label>
        <select class="form-select" id="category" name="category" required>
          <option value="Bakery" <%= product.category === 'Bakery' ? 'selected' : '' %>>Bakery</option>
          <option value="Beauty & Personal Care" <%= product.category === 'Beauty & Personal Care' ? 'selected' : '' %>>Beauty & Personal Care</option>
          <option value="Diary" <%= product.category === 'Diary' ? 'selected' : '' %>>Diary</option>
          <option value="Drinks" <%= product.category === 'Drinks' ? 'selected' : '' %>>Drinks</option>
          <option value="Fruits" <%= product.category === 'Fruits' ? 'selected' : '' %>>Fruits</option>
          <option value="Household" <%= product.category === 'Household' ? 'selected' : '' %>>Household</option>
          <option value="Lifestyle" <%= product.category === 'Lifestyle' ? 'selected' : '' %>>Lifestyle</option>
          <option value="Meat" <%= product.category === 'Meat' ? 'selected' : '' %>>Meat</option>
          <option value="Rice, Noodles & Cooking Ingredients" <%= product.category === 'Rice, Noodles & Cooking Ingredients' ? 'selected' : '' %>>Rice, Noodles & Cooking Ingredients</option>
          <option value="Seafood" <%= product.category === 'Seafood' ? 'selected' : '' %>>Seafood</option>
          <option value="Snacks" <%= product.category === 'Snacks' ? 'selected' : '' %>>Snacks</option>
          <option value="Vegetables" <%= product.category === 'Vegetables' ? 'selected' : '' %>>Vegetables</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="origin" class="form-label">Origin</label>
        <input type="text" class="form-control" id="origin" name="origin" value="<%= product.origin || '' %>" required>
      </div>

      <div class="mb-3">
        <label for="description" class="form-label">Description</label>
        <textarea class="form-control" id="description" name="description" rows="3"><%= product.description || '' %></textarea>
      </div>

      <div class="mb-3">
        <label for="halal" class="form-label">Halal</label>
        <select class="form-select" id="halal" name="halal" required>
          <option value="1" <%= product.halal ? 'selected' : '' %>>Yes</option>
          <option value="0" <%= !product.halal ? 'selected' : '' %>>No</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="quantity" class="form-label">Quantity</label>
        <input type="number" class="form-control" id="quantity" name="quantity" min="0" step="1"
          value="<%= product.quantity %>" required>
      </div>

      <div class="mb-3">
        <label for="price" class="form-label">Price</label>
        <input type="number" class="form-control" id="price" name="price" min="0" step="0.01"
          value="<%= product.price %>" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Current Image</label>
        <input type="text" class="form-control" name="currentImage" value="<%= product.image %>" readonly>
        <img src="/images/<%= product.image %>" class="img-thumbnail mt-2" style="width: 150px;">
      </div>

      <div class="mb-3">
        <label for="image" class="form-label">Upload New Primary Image</label>
        <input class="form-control" type="file" id="image" name="image" accept="image/*" >
      </div>

      <% if (additionalImages.length) { %>
        <div class="mb-3">
          <label class="form-label">Current Additional Images</label>
          <div class="d-flex flex-wrap gap-2">
            <% additionalImages.forEach(function(img) { %>
              <img src="/images/<%= img %>" class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover;">
            <% }) %>
          </div>
        </div>
      <% } %>

      <div class="mb-4">
        <label for="additionalImages" class="form-label">Add More Images</label>
        <input class="form-control" type="file" id="additionalImages" name="additionalImages" accept="image/*" multiple>
        <input type="hidden" name="existingAdditionalImages" value="<%= additionalImages.join(',') %>">
      </div>

      <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary">Update Product</button>
        <a href="/inventory" class="btn btn-secondary">Back to Inventory</a>
      </div>
    </form>
    <% } else { %>
      <p class="text-center">No product found.</p>
      <% } %>
</div>
